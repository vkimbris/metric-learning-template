schema: '2.0'
stages:
  split:
    cmd: python src/split.py
    deps:
    - path: data/data.parquet
      hash: md5
      md5: cd5777d15a7f6de6dbe9faeb565bb730
      size: 1425743
    - path: src/split.py
      hash: md5
      md5: 0fd57d6386cc649751fca4edaf3cf2c7
      size: 983
    - path: src/utils/splitters/
      hash: md5
      md5: e708c50e2994a8b98cdd65b2311df30b.dir
      size: 18581
      nfiles: 18
    params:
      params.yaml:
        split:
          _target_: utils.splitters.RandomSplitter
          add_validation: true
          stratify: charcName
          test_size: 0.1
          random_state: 21
    outs:
    - path: artifacts/dataset
      hash: md5
      md5: 2190f5676cf8633f2aefe53751e22373.dir
      size: 4712242
      nfiles: 10
  negative_sampling:
    cmd: python src/negative_sampling.py
    deps:
    - path: artifacts/dataset
      hash: md5
      md5: 2190f5676cf8633f2aefe53751e22373.dir
      size: 4712242
      nfiles: 10
    - path: src/negative_sampling.py
      hash: md5
      md5: 2d8a140b9a38192c63c65260712ab526
      size: 898
    - path: src/utils/negative_samplers/
      hash: md5
      md5: 7297017a2c0e8df8ec9a5dd5f2daf7c7.dir
      size: 18140
      nfiles: 12
    params:
      params.yaml:
        negative_sampling:
          _target_: utils.negative_samplers.MaskedHardNegativeSampler
          model:
            _target_: sentence_transformers.SentenceTransformer
            model_name_or_path: intfloat/multilingual-e5-small
            prompts:
              query: 'query: '
            default_prompt_name: query
          n_negatives: 1
          as_triplets: true
          model_encoding_params:
            batch_size: 1024
          masked_semantic_search_params:
            verbose: true
            query_chunk_size: 10000
    outs:
    - path: artifacts/dataset_with_negatives
      hash: md5
      md5: 6601a0cd5d73682b42be14f235c64f22.dir
      size: 8841699
      nfiles: 10
  train:
    cmd: python src/train.py
    deps:
    - path: artifacts/dataset_with_negatives
      hash: md5
      md5: 6601a0cd5d73682b42be14f235c64f22.dir
      size: 8841699
      nfiles: 10
    - path: src/train.py
      hash: md5
      md5: 431b488b5e860a7bb838555d6839ef8f
      size: 2286
    - path: src/utils/evaluators/
      hash: md5
      md5: 6523acd2f4d3e206c0d732d7a7d73179.dir
      size: 21774
      nfiles: 6
    params:
      params.yaml:
        train:
          model:
            _target_: sentence_transformers.SentenceTransformer
            model_name_or_path: intfloat/multilingual-e5-small
            prompts:
              query: 'query: '
              passage: 'passage: '
            default_prompt_name: query
          loss:
            _target_: sentence_transformers.losses.MultipleNegativesRankingLoss
          evaluator:
            _target_: utils.evaluators.MappingEvaluator
            compute_metrics_fn:
              _target_: utils.evaluators.compute_precision_recall_f_beta_score
              beta: 2
          args:
            _target_: sentence_transformers.SentenceTransformerTrainingArguments
            do_train: true
            num_train_epochs: 3
            eval_strategy: epoch
            save_strategy: epoch
            per_device_train_batch_size: 256
            learning_rate: 0.0002
            seed: 21
            warmup_steps: 20
            save_total_limit: 1
            metric_for_best_model: f_score
    outs:
    - path: artifacts/trainer
      hash: md5
      md5: 569c952954b49a8d907a431f64325802.dir
      size: 1428022978
      nfiles: 16
    - path: models/charcs-mapper
      hash: md5
      md5: 9ad7a1aa8ddf303f0f63c509ad835e2b.dir
      size: 487787589
      nfiles: 10
  evaluate:
    cmd: python src/evaluate.py
    deps:
    - path: artifacts/dataset
      hash: md5
      md5: 2190f5676cf8633f2aefe53751e22373.dir
      size: 4712242
      nfiles: 10
    - path: artifacts/trainer
      hash: md5
      md5: 569c952954b49a8d907a431f64325802.dir
      size: 1428022978
      nfiles: 16
    - path: models/charcs-mapper
      hash: md5
      md5: 9ad7a1aa8ddf303f0f63c509ad835e2b.dir
      size: 487787589
      nfiles: 10
    - path: src/evaluate.py
      hash: md5
      md5: e873fe798baa977feae7ae4736185fc6
      size: 2026
    - path: src/utils/evaluators/
      hash: md5
      md5: 6523acd2f4d3e206c0d732d7a7d73179.dir
      size: 21774
      nfiles: 6
    params:
      params.yaml:
        evaluate:
          evaluator:
            _target_: utils.evaluators.MappingEvaluator
            compute_metrics_fn:
              _target_: utils.evaluators.compute_precision_recall_f_beta_score
              beta: 2
    outs:
    - path: metrics/aggregated_metrics.json
      hash: md5
      md5: f3e1927e9557b02523297a14b2bbd8b9
      size: 95
    - path: metrics/metrics.json
      hash: md5
      md5: 552053833536a80d958c13df6fa9e571
      size: 130
